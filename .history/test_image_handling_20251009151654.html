<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Image Handling</title>
    <style>
        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin: 16px;
            width: 300px;
            display: inline-block;
        }
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 4px;
        }
        .product-name {
            font-size: 18px;
            font-weight: bold;
            margin: 8px 0;
        }
        .test-results {
            background: #f5f5f5;
            padding: 16px;
            margin: 16px;
            border-radius: 8px;
        }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Image Handling Test</h1>
    <div class="test-results" id="testResults"></div>
    <div id="productsContainer"></div>

    <script>
        // Test data with various image URL types
        const testProducts = [
            {
                name: "Test Product 1",
                image_url: "https://example.com/test1.jpg",
                price: 99.99,
                category: "Electronics",
                description: "This should use fallback image",
                score: 0.8
            },
            {
                name: "Test Product 2", 
                image_url: "https://example.com/test2.jpg",
                price: 149.99,
                category: "Jewelry",
                description: "This should also use fallback image",
                score: 0.75
            },
            {
                name: "Valid Product",
                image_url: "https://via.placeholder.com/300x200/4CAF50/white?text=Valid+Image",
                price: 199.99,
                category: "Valid",
                description: "This should show the actual image",
                score: 0.9
            },
            {
                name: "Base64 Product",
                image_url: "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==",
                price: 299.99,
                category: "Base64",
                description: "This should show as base64 image",
                score: 0.85
            }
        ];

        function displayResults(results) {
            const container = document.getElementById('productsContainer');
            const testResults = document.getElementById('testResults');
            let successCount = 0;
            let errorCount = 0;
            
            if (!results || results.length === 0) {
                container.innerHTML = '<p>No results found.</p>';
                return;
            }

            const productsGrid = document.createElement('div');
            productsGrid.className = 'products-grid';

            results.forEach((item, index) => {
                // This is the same logic from app.js
                let imageSrc = '';
                const svgPlaceholder = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjBGMEYwIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM2NjY2NjYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ObyBJbWFnZTwvdGV4dD4KPC9zdmc+';
                
                // Check image_url first (most reliable source)
                if (item.image_url && item.image_url.trim() && !item.image_url.includes('placeholder.com') && !item.image_url.includes('example.com')) {
                    if (item.image_url.match(/^[A-Za-z0-9+/]{20,}/)) {
                        // It's base64 data, create a data URI
                        imageSrc = `data:image/jpeg;base64,${item.image_url}`;
                    } else if (item.image_url.startsWith('data:') || item.image_url.startsWith('http')) {
                        // It's already a data URI or external URL (but not placeholder)
                        imageSrc = item.image_url;
                    } else {
                        // Skip invalid URLs
                        imageSrc = svgPlaceholder;
                    }
                } else {
                    // Always use inline SVG placeholder for missing images or blocked URLs
                    imageSrc = svgPlaceholder;
                }

                // Test if the image handling worked correctly
                const originalUrl = item.image_url;
                const isBlockedUrl = originalUrl && (originalUrl.includes('example.com') || originalUrl.includes('placeholder.com'));
                const isUsingFallback = imageSrc === svgPlaceholder;
                
                if (isBlockedUrl && isUsingFallback) {
                    successCount++;
                } else if (!isBlockedUrl && !isUsingFallback) {
                    successCount++;
                } else {
                    errorCount++;
                }

                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <img src="${imageSrc}" 
                         alt="${item.name}"
                         class="product-image"
                         onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjBGMEYwIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM2NjY2NjYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ObyBJbWFnZTwvdGV4dD4KPC9zdmc+';"
                         style="width: 100%; height: 200px; object-fit: cover;">
                    <div class="product-info">
                        <h3 class="product-name">${item.name}</h3>
                        <p class="product-price">$${item.price || 'N/A'}</p>
                        <p class="product-category">${item.category}</p>
                        <p class="product-description">${item.description && item.description.trim() ? item.description : 'No description available'}</p>
                        <p class="similarity-score">Similarity: ${item.score ? `${(item.score * 100).toFixed(1)}%` : 'N/A'}</p>
                        <p><strong>Original URL:</strong> ${originalUrl || 'None'}</p>
                        <p><strong>Using Fallback:</strong> ${isUsingFallback ? 'Yes' : 'No'}</p>
                    </div>
                `;
                productsGrid.appendChild(productCard);
            });

            container.innerHTML = '';
            container.appendChild(productsGrid);
            
            // Display test results
            testResults.innerHTML = `
                <h3>Test Results:</h3>
                <p class="success">✅ Successful image handling: ${successCount}</p>
                <p class="error">❌ Failed image handling: ${errorCount}</p>
                <p><strong>Expected behavior:</strong></p>
                <ul>
                    <li>Products with example.com URLs should use SVG fallback</li>
                    <li>Products with valid URLs should show actual images</li>
                    <li>Base64 data should be rendered as images</li>
                </ul>
                <p><strong>Console errors:</strong> Check browser console for any ORB errors (expected for example.com URLs)</p>
            `;
        }

        // Run the test
        displayResults(testProducts);
    </script>
</body>
</html>